<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1F292E" id="meta-theme-color">
    <!-- PWA用 -->
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon-192.png">
    
    <title>経費精算</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- テーマ変数定義 --- */
        :root {
            /* デフォルト（ダーク） */
            --bg-color: #1F292E;
            --card-bg: #27353A;
            --input-bg: #191F22;
            --text-main: #FFFFFF;
            --text-sub: #B0B5B9;
            --accent-green: #06C755;
            --border-color: #3A474D;
            --nav-bg: #263238;
            --icon-active: #4DB6AC;
        }

        /* ライトテーマ */
        body.theme-light {
            --bg-color: #F0F2F5;
            --card-bg: #FFFFFF;
            --input-bg: #F5F6F7;
            --text-main: #333333;
            --text-sub: #666666;
            --accent-green: #06C755;
            --border-color: #DDDDDD;
            --nav-bg: #FFFFFF;
            --icon-active: #00897B;
        }

        /* ミッドナイトテーマ */
        body.theme-midnight {
            --bg-color: #0F172A;
            --card-bg: #1E293B;
            --input-bg: #0F172A;
            --text-main: #E2E8F0;
            --text-sub: #94A3B8;
            --accent-green: #3B82F6; /* 青系アクセント */
            --border-color: #334155;
            --nav-bg: #1E293B;
            --icon-active: #60A5FA;
        }

        /* --- 基本スタイル --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            /* 下部固定エリア + iPhoneセーフエリア */
            padding-bottom: calc(140px + env(safe-area-inset-bottom));
            padding-top: env(safe-area-inset-top);
            transition: background-color 0.3s, color 0.3s;
        }

        /* ヘッダー */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background-color: var(--bg-color);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s;
        }
        .header-title {
            font-size: 18px;
            font-weight: bold;
            flex-grow: 1;
            margin-left: 20px;
            text-align: center;
        }
        .icon-btn {
            background: none;
            border: none;
            color: var(--text-main);
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }
        .icon-sub { color: var(--text-sub); }

        /* コンテンツエリア */
        .container { padding: 10px 15px; }
        .view-section { display: none; } /* タブ切り替え用 */
        .view-section.active { display: block; animation: fadeIn 0.3s; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 12px;
            color: var(--text-sub);
            margin: 15px 0 8px 5px;
        }

        .grid-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid var(--border-color);
        }

        .label {
            display: block;
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--text-sub);
        }

        .input-wrapper {
            position: relative;
            background-color: var(--input-bg);
            border-radius: 6px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            border: 1px solid var(--border-color);
        }
        
        .input-wrapper:focus-within {
            border-color: var(--text-sub);
        }

        input[type="number"], input[type="text"] {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text-main);
            font-size: 18px;
            font-weight: bold;
            text-align: right;
            padding: 12px 25px 12px 5px;
            outline: none;
        }
        
        /* 備考欄用 */
        textarea {
            width: 100%;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            border-radius: 8px;
            padding: 10px;
            font-size: 14px;
            resize: none;
            outline: none;
            min-height: 80px;
        }

        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        .unit {
            position: absolute;
            right: 10px;
            color: var(--text-sub);
            font-size: 12px;
            pointer-events: none;
        }

        /* カスタム項目 */
        .custom-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
        }
        .custom-name-input {
            text-align: left;
            font-size: 14px;
            width: 50%;
            padding: 12px 0;
            color: var(--text-main);
        }
        .custom-val-wrapper { width: 45%; }

        /* 合計金額エリア */
        .total-area {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border-color);
        }
        .total-label {
            font-size: 12px;
            color: var(--text-sub);
            margin-bottom: 5px;
        }
        .total-amount {
            font-size: 28px;
            font-weight: bold;
            color: var(--icon-active);
        }
        .calc-icon {
            background-color: var(--border-color);
            color: var(--text-main);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        /* 設定画面用スタイル */
        .settings-group {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
        }
        .settings-header {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 14px;
            color: var(--text-main);
        }
        .theme-buttons {
            display: flex;
            gap: 10px;
        }
        .theme-btn {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            border: 2px solid var(--border-color);
            background-color: var(--input-bg);
            color: var(--text-main);
            font-weight: bold;
            cursor: pointer;
        }
        .theme-btn.active {
            border-color: var(--accent-green);
            color: var(--accent-green);
        }
        .settings-input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }
        .settings-input-row:last-child { border-bottom: none; }
        .settings-input-label { font-size: 13px; color: var(--text-sub); }
        .settings-val-input {
            width: 100px;
            text-align: right;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-main);
            border-radius: 4px;
            padding: 5px;
        }
        .save-btn {
            width: 100%;
            background-color: var(--icon-active);
            color: white;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
            margin-top: 10px;
            cursor: pointer;
        }

        /* 下部固定エリア */
        .bottom-fixed {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--bg-color);
            z-index: 200;
            border-top: 1px solid var(--border-color);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .line-btn-area { padding: 15px 20px; }
        .line-btn {
            background-color: var(--accent-green);
            color: white;
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: none;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .line-btn:active { transform: scale(0.98); }

        /* ナビゲーションバー */
        .nav-bar {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            background-color: var(--nav-bg);
            border-top: 1px solid var(--border-color);
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-sub);
            font-size: 10px;
            gap: 5px;
            cursor: pointer;
            width: 33%;
        }
        .nav-item i { font-size: 20px; }
        .nav-item.active { color: var(--icon-active); }

    </style>
</head>
<body>

    <!-- ヘッダー -->
    <header>
        <!-- 左上は今は機能なし -->
        <button class="icon-btn" style="opacity: 0;"><i class="fa-solid fa-chevron-left"></i></button> 
        <div class="header-title" id="header-title">経費入力</div>
        <!-- リセットボタン -->
        <button class="icon-btn icon-sub" onclick="resetToDefaults()"><i class="fa-solid fa-rotate-right"></i></button>
    </header>

    <div class="container">
        
        <!-- ======= ホーム（計算）ビュー ======= -->
        <div id="view-home" class="view-section active">
            
            <div class="section-title">保険・税金</div>
            <div class="grid-row">
                <div class="card">
                    <label class="label">自賠責保険</label>
                    <div class="input-wrapper">
                        <input type="number" class="calc-target" id="inp-jibai" data-key="jibai" data-name="自賠責保険">
                        <span class="unit">円</span>
                    </div>
                </div>
                <div class="card">
                    <label class="label">重量税</label>
                    <div class="input-wrapper">
                        <input type="number" class="calc-target" id="inp-weight" data-key="weight" data-name="重量税">
                        <span class="unit">円</span>
                    </div>
                </div>
            </div>

            <div class="section-title">手数料・テスター</div>
            <div class="grid-row">
                <div class="card">
                    <label class="label">検査手数料</label>
                    <div class="input-wrapper">
                        <input type="number" class="calc-target" id="inp-fee" data-key="fee" data-name="検査手数料">
                        <span class="unit">円</span>
                    </div>
                </div>
                <div class="card">
                    <label class="label">テスター代</label>
                    <div class="input-wrapper">
                        <input type="number" class="calc-target" id="inp-tester" data-key="tester" data-name="テスター代">
                        <span class="unit">円</span>
                    </div>
                </div>
            </div>

            <div class="section-title">燃料・部品</div>
            <div class="grid-row">
                <div class="card">
                    <label class="label">ガソリン代</label>
                    <div class="input-wrapper">
                        <input type="number" class="calc-target" id="inp-gas" data-key="gas" data-name="ガソリン代">
                        <span class="unit">円</span>
                    </div>
                </div>
                <div class="card">
                    <label class="label">部品代</label>
                    <div class="input-wrapper">
                        <input type="number" class="calc-target" id="inp-parts" data-key="parts" data-name="部品代">
                        <span class="unit">円</span>
                    </div>
                </div>
            </div>

            <div class="section-title">カスタム項目</div>
            <div class="custom-row">
                <input type="text" class="custom-name-input" id="inp-c1-name" value="項目名 1">
                <div class="input-wrapper custom-val-wrapper">
                    <input type="number" class="calc-target" id="inp-c1-val" data-name-ref="inp-c1-name">
                    <span class="unit">円</span>
                </div>
            </div>
            <div class="custom-row">
                <input type="text" class="custom-name-input" id="inp-c2-name" value="項目名 2">
                <div class="input-wrapper custom-val-wrapper">
                    <input type="number" class="calc-target" id="inp-c2-val" data-name-ref="inp-c2-name">
                    <span class="unit">円</span>
                </div>
            </div>

            <div class="section-title">備考</div>
            <textarea id="notes" placeholder="備考があれば入力してください（LINEに転送されます）"></textarea>

            <div class="total-area">
                <div>
                    <div class="total-label">合計金額</div>
                    <div class="total-amount" id="display-total">¥ 0</div>
                </div>
                <div class="calc-icon">
                    <i class="fa-solid fa-calculator"></i>
                </div>
            </div>

            <!-- 余白 -->
            <div style="height: 20px;"></div>
        </div>

        <!-- ======= 設定ビュー ======= -->
        <div id="view-settings" class="view-section">
            <div class="settings-group">
                <div class="settings-header">テーマ設定</div>
                <div class="theme-buttons">
                    <div class="theme-btn active" onclick="setTheme('dark', this)">Dark</div>
                    <div class="theme-btn" onclick="setTheme('light', this)">Light</div>
                    <div class="theme-btn" onclick="setTheme('midnight', this)">Midnight</div>
                </div>
            </div>

            <div class="settings-group">
                <div class="settings-header">初期値の設定</div>
                <div class="settings-input-row">
                    <span class="settings-input-label">自賠責保険</span>
                    <input type="number" id="set-jibai" class="settings-val-input">
                </div>
                <div class="settings-input-row">
                    <span class="settings-input-label">重量税</span>
                    <input type="number" id="set-weight" class="settings-val-input">
                </div>
                <div class="settings-input-row">
                    <span class="settings-input-label">検査手数料</span>
                    <input type="number" id="set-fee" class="settings-val-input">
                </div>
                <div class="settings-input-row">
                    <span class="settings-input-label">テスター代</span>
                    <input type="number" id="set-tester" class="settings-val-input">
                </div>
                <div class="settings-input-row">
                    <span class="settings-input-label">ガソリン代</span>
                    <input type="number" id="set-gas" class="settings-val-input">
                </div>
                <div class="settings-input-row">
                    <span class="settings-input-label">部品代</span>
                    <input type="number" id="set-parts" class="settings-val-input">
                </div>
                <button class="save-btn" onclick="saveSettings()">設定を保存</button>
            </div>
            <div style="text-align: center; font-size: 11px; color: var(--text-sub);">
                ※保存すると計算画面の数値は初期値にリセットされます。
            </div>
        </div>

    </div>

    <!-- 下部固定エリア -->
    <div class="bottom-fixed">
        <div class="line-btn-area" id="line-area">
            <button class="line-btn" onclick="sendToLine()">
                <i class="fa-solid fa-comment"></i> LINEへ送る
            </button>
        </div>
        
        <div class="nav-bar">
            <div class="nav-item active" id="nav-home" onclick="switchTab('home')">
                <i class="fa-solid fa-house"></i>
                <span>ホーム</span>
            </div>
            <!-- 履歴は削除、代わりに設定を -->
            <div class="nav-item" id="nav-settings" onclick="switchTab('settings')">
                <i class="fa-solid fa-gear"></i>
                <span>設定</span>
            </div>
        </div>
    </div>

    <script>
        // デフォルト設定
        const defaultSettings = {
            theme: 'dark',
            values: {
                jibai: 17540,
                weight: 0,
                fee: 2200,
                tester: 900,
                gas: 0,
                parts: 0
            }
        };

        // 現在の設定（ローカルストレージから読み込み）
        let currentSettings = JSON.parse(localStorage.getItem('expenseAppSettings')) || JSON.parse(JSON.stringify(defaultSettings));

        // 要素取得
        const inputs = document.querySelectorAll('.calc-target');
        const displayTotal = document.getElementById('display-total');
        const headerTitle = document.getElementById('header-title');
        const lineArea = document.getElementById('line-area');

        // アプリ初期化
        function initApp() {
            applyTheme(currentSettings.theme);
            loadSettingsToInputs(); // 設定画面のinputに値をセット
            resetToDefaults();      // 計算画面を初期値にする
            calculateTotal();
        }

        // テーマ適用
        function applyTheme(themeName) {
            document.body.className = ''; // クラスリセット
            if (themeName !== 'dark') {
                document.body.classList.add('theme-' + themeName);
            }
            // 設定画面のボタン状態更新
            document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = Array.from(document.querySelectorAll('.theme-btn')).find(b => b.textContent.toLowerCase().includes(themeName));
            if(activeBtn) activeBtn.classList.add('active');
            
            // meta theme-colorも更新（Androidステータスバー用）
            const metaTheme = document.getElementById('meta-theme-color');
            if(themeName === 'light') metaTheme.content = "#F0F2F5";
            else if(themeName === 'midnight') metaTheme.content = "#0F172A";
            else metaTheme.content = "#1F292E";
        }

        // テーマ選択（UIイベント）
        function setTheme(theme, btn) {
            applyTheme(theme);
            // 保存は「設定を保存」ボタンで行うが、プレビューとして即時反映させる
            // ただしcurrentSettingsはまだ更新しない
        }

        // 設定値を入力欄に反映
        function loadSettingsToInputs() {
            document.getElementById('set-jibai').value = currentSettings.values.jibai;
            document.getElementById('set-weight').value = currentSettings.values.weight;
            document.getElementById('set-fee').value = currentSettings.values.fee;
            document.getElementById('set-tester').value = currentSettings.values.tester;
            document.getElementById('set-gas').value = currentSettings.values.gas;
            document.getElementById('set-parts').value = currentSettings.values.parts;
        }

        // 設定保存
        function saveSettings() {
            // テーマ取得
            let selectedTheme = 'dark';
            if (document.body.classList.contains('theme-light')) selectedTheme = 'light';
            if (document.body.classList.contains('theme-midnight')) selectedTheme = 'midnight';

            // 値取得
            const newValues = {
                jibai: parseInt(document.getElementById('set-jibai').value) || 0,
                weight: parseInt(document.getElementById('set-weight').value) || 0,
                fee: parseInt(document.getElementById('set-fee').value) || 0,
                tester: parseInt(document.getElementById('set-tester').value) || 0,
                gas: parseInt(document.getElementById('set-gas').value) || 0,
                parts: parseInt(document.getElementById('set-parts').value) || 0
            };

            currentSettings = {
                theme: selectedTheme,
                values: newValues
            };

            localStorage.setItem('expenseAppSettings', JSON.stringify(currentSettings));
            
            alert('設定を保存しました');
            resetToDefaults(); // 計算画面に反映
            switchTab('home'); // ホームに戻る
        }

        // リセット（初期値に戻す）
        function resetToDefaults() {
            const v = currentSettings.values;
            
            // 各Inputに値をセット
            setVal('inp-jibai', v.jibai);
            setVal('inp-weight', v.weight);
            setVal('inp-fee', v.fee);
            setVal('inp-tester', v.tester);
            setVal('inp-gas', v.gas);
            setVal('inp-parts', v.parts);

            // カスタム項目と備考はクリア
            document.getElementById('inp-c1-val').value = '';
            document.getElementById('inp-c2-val').value = '';
            document.getElementById('notes').value = '';

            calculateTotal();
        }

        function setVal(id, val) {
            const el = document.getElementById(id);
            if(el) el.value = val === 0 ? '' : val; // 0なら空文字の方が見やすい場合もあるが、placeholderあるのでOK。要望通り初期値を入れる。
        }

        // タブ切り替え
        function switchTab(tabName) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

            document.getElementById('view-' + tabName).classList.add('active');
            document.getElementById('nav-' + tabName).classList.add('active');

            if (tabName === 'home') {
                headerTitle.textContent = "経費入力";
                lineArea.style.display = 'block'; // LINEボタン表示
                document.querySelector('.fa-rotate-right').parentElement.style.visibility = 'visible';
            } else {
                headerTitle.textContent = "設定";
                lineArea.style.display = 'none'; // 設定画面ではLINEボタン隠す
                document.querySelector('.fa-rotate-right').parentElement.style.visibility = 'hidden';
            }
        }

        // 計算ロジック
        function calculateTotal() {
            let total = 0;
            inputs.forEach(input => {
                const val = parseInt(input.value);
                if (!isNaN(val)) {
                    total += val;
                }
            });
            displayTotal.textContent = "¥ " + total.toLocaleString();
        }

        inputs.forEach(input => {
            input.addEventListener('input', calculateTotal);
        });

        // LINE用フォーマッター（簡易的な右揃え）
        function formatLineItem(name, price) {
            // 全角スペースを使ってパディングを試みる（LINEのフォントサイズ設定によるが、ある程度揃う）
            const priceStr = price.toLocaleString() + "円";
            // 名前と金額の間に全角スペースを入れる
            return `${name}　${priceStr}`;
        }

        // LINE送信
        function sendToLine() {
            let message = "【経費精算】\n\n";
            let hasItem = false;

            // 固定項目
            document.querySelectorAll('.card .calc-target').forEach(input => {
                const val = parseInt(input.value);
                const name = input.getAttribute('data-name');
                if (!isNaN(val) && val > 0) {
                    message += formatLineItem(name, val) + "\n";
                    hasItem = true;
                }
            });

            // カスタム項目
            document.querySelectorAll('.custom-row').forEach(row => {
                const nameInput = row.querySelector('.custom-name-input');
                const valInput = row.querySelector('.calc-target');
                const val = parseInt(valInput.value);

                if (!isNaN(val) && val > 0) {
                    const itemName = nameInput.value || "未設定";
                    message += formatLineItem(itemName, val) + "\n";
                    hasItem = true;
                }
            });

            const total = calculateTotal().toString(); // calculateTotal returns void in current logic, need fix
            // 再計算して合計取得
            let totalVal = 0;
            inputs.forEach(i => totalVal += (parseInt(i.value)||0));
            
            if (!hasItem) {
                alert("送信する項目がありません（0円は除外されます）");
                return;
            }

            // 備考欄
            const notes = document.getElementById('notes').value.trim();

            message += `\n----------------\n合計　${totalVal.toLocaleString()}円`;
            
            if(notes) {
                message += `\n\n■備考\n${notes}`;
            }

            const encodedMessage = encodeURIComponent(message);
            window.location.href = `https://line.me/R/msg/text/?${encodedMessage}`;
        }

        // Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js');
            });
        }

        // 初回実行
        initApp();

    </script>
</body>
</html>